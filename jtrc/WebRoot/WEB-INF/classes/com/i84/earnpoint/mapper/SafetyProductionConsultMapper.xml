<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.i84.earnpoint.mapper.SafetyProductionConsultMapper">
  <resultMap id="BaseResultMap" type="com.i84.earnpoint.model.SafetyProductionConsult">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="enterprise_id" jdbcType="INTEGER" property="enterpriseId" />
    <result column="type" jdbcType="INTEGER" property="type" />
    <result column="check_state" jdbcType="INTEGER" property="checkState" />
    <result column="contract_state" jdbcType="INTEGER" property="contractState" />
    <result column="train_state" jdbcType="INTEGER" property="trainState" />
    <result column="train_check_state" jdbcType="INTEGER" property="trainCheckState" />
    <result column="check_count" jdbcType="INTEGER" property="checkCount" />
    <result column="contract_name" jdbcType="VARCHAR" property="contractName" />
    <result column="contract_path" jdbcType="VARCHAR" property="contractPath" />
    <result column="train_remark" jdbcType="VARCHAR" property="trainRemark" />
    <result column="train_msg" jdbcType="VARCHAR" property="trainMsg" />
    <result column="add_date" jdbcType="TIMESTAMP" property="addDate" />
    <result column="del_date" jdbcType="TIMESTAMP" property="delDate" />
    <result column="check_remark" jdbcType="VARCHAR" property="checkRemark" />
    <result column="last_check_date" jdbcType="TIMESTAMP" property="lastCheckDate" />
    <result column="last_check_remark" jdbcType="VARCHAR" property="lastCheckRemark" />
    <result column="last_check_state" jdbcType="INTEGER" property="lastCheckState" />
    <result column="last_check_id" jdbcType="INTEGER" property="lastCheckId" />
    <result column="check_date" jdbcType="TIMESTAMP" property="checkDate" />
    <result column="contract_date" jdbcType="TIMESTAMP" property="contractDate" />
    <result column="train_add_date" jdbcType="TIMESTAMP" property="trainAddDate" />
    <result column="train_date" jdbcType="TIMESTAMP" property="trainDate" />
    <result column="train_check_date" jdbcType="TIMESTAMP" property="trainCheckDate" />
    <result column="last_check_add_date" jdbcType="TIMESTAMP" property="lastCheckAddDate" />
    <result column="pno" jdbcType="VARCHAR" property="pno" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, check_date,contract_date,train_add_date,train_date,train_check_date,last_check_add_date,pno,enterprise_id, type, check_state,last_check_date,last_check_remark,last_check_state,last_check_id,train_check_state,check_remark, contract_state,train_state, check_count, contract_name, contract_path, train_remark, train_msg, add_date, del_date
  </sql>
  <update id="updateByPrimaryKeySelective" parameterType="com.i84.earnpoint.model.SafetyProductionConsult">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update safety_production_consult
    <set>
      <if test="enterpriseId != null">
        enterprise_id = #{enterpriseId,jdbcType=INTEGER},
      </if>
      <if test="type != null">
        type = #{type,jdbcType=INTEGER},
      </if>
      <if test="checkState != null">
        check_state = #{checkState,jdbcType=INTEGER},
      </if>
      <if test="trainState != null">
        train_state = #{trainState,jdbcType=INTEGER},
      </if>
      <if test="trainCheckState != null">
        train_check_state = #{trainCheckState,jdbcType=INTEGER},
      </if>
      <if test="checkCount != null">
        check_count = #{checkCount,jdbcType=INTEGER},
      </if>
      <if test="contractState != null">
        contract_state = #{contractState,jdbcType=VARCHAR},
      </if>
      <if test="contractName != null">
        contract_name = #{contractName,jdbcType=VARCHAR},
      </if>
      <if test="contractPath != null">
        contract_path = #{contractPath,jdbcType=VARCHAR},
      </if>
      <if test="trainRemark != null">
        train_remark = #{trainRemark,jdbcType=VARCHAR},
      </if>
      <if test="trainMsg != null">
        train_msg = #{trainMsg,jdbcType=VARCHAR},
      </if>
      <if test="addDate != null">
        add_date = #{addDate,jdbcType=TIMESTAMP},
      </if>
      <if test="delDate != null">
        del_date = #{delDate,jdbcType=TIMESTAMP},
      </if>
      <if test="checkRemark != null">
        check_remark = #{checkRemark,jdbcType=VARCHAR},
      </if>
      <if test="lastCheckDate != null">
        last_check_date = #{lastCheckDate,jdbcType=TIMESTAMP},
      </if>
      <if test="lastCheckRemark != null">
        last_check_remark = #{lastCheckRemark,jdbcType=VARCHAR},
      </if>
      <if test="lastCheckState != null">
        last_check_state = #{lastCheckState,jdbcType=INTEGER},
      </if>
      <if test="lastCheckId != null">
        last_check_id = #{lastCheckId,jdbcType=INTEGER},
      </if>
      <if test="checkDate != null">
        check_date = #{checkDate,jdbcType=TIMESTAMP},
      </if>
      <if test="contractDate != null">
        contract_date = #{contractDate,jdbcType=TIMESTAMP},
      </if>
      <if test="trainAddDate != null">
        train_add_date = #{trainAddDate,jdbcType=TIMESTAMP},
      </if>
      <if test="trainDate != null">
        train_date = #{trainDate,jdbcType=TIMESTAMP},
      </if>
      <if test="trainCheckDate != null">
        train_check_date = #{trainCheckDate,jdbcType=TIMESTAMP},
      </if>
      <if test="lastCheckAddDate != null">
        last_check_add_date = #{lastCheckAddDate,jdbcType=TIMESTAMP},
      </if>
      <if test="pno != null">
        pno = #{pno,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <select id="qrySafetyProductionConsultList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
       SELECT
			a.id,a.pno,
			a.check_state AS checkState,
			a.check_remark AS checkRemark,
			a.train_check_state AS trainCheckState,
			a.check_count AS checkCount,
			a.contract_name AS contractName,
			a.contract_path AS contractPath,
			a.contract_state AS contractState,
			date_format(a.del_date, '%Y-%m-%d') AS delDate,
			a.enterprise_id AS enterpriseId,
			a.train_msg AS trainMsg,
			a.train_remark AS trainRemark,
			a.train_state AS trainState,
			a.type,
			date_format(a.add_date, '%Y-%m-%d') AS addDate,
			date_format(a.last_check_date, '%Y-%m-%d') AS lastCheckDate,
			date_format(a.check_date, '%Y-%m-%d') AS checkDate,
			date_format(a.contract_date, '%Y-%m-%d') AS contractDate,
			date_format(a.train_add_date, '%Y-%m-%d') AS trainAddDate,
			date_format(a.train_date, '%Y-%m-%d') AS trainDate,
			date_format(a.train_check_date, '%Y-%m-%d') AS trainCheckDate,
			date_format(a.last_check_add_date, '%Y-%m-%d') AS lastCheckAddDate,
			a.last_check_remark AS lastCheckRemark,
			a.last_check_state AS lastCheckState,
			a.last_check_id AS lastCheckId,
			b.c_code AS cCode,
			b.`name` AS name,
		      b.pro_id as proId,
		      b.business_scope as businessScope,
		      date_format(b.registration_time, '%Y-%m-%d') AS registrationTime,
		      b.contact_name as contactName,
		      b.address as address,
		      b.sname as sname,
		      b.tel as tel,
		      b.business_license_name as businessLicenseName,
		      b.business_license_path as businessLicensePath,
		      b.tax_registration_certificate_name as taxRegistrationCertificateName,
		      b.tax_registration_certificate_path as taxRegistrationCertificatePath,
		      b.org_code_certificate_name as orgCodeCertificateName,
		      b.org_code_certificate_path as orgCodeCertificatePath,
		      b.remark as remark,
			c.`name` AS parentName
		FROM
			safety_production_consult a
		INNER JOIN enterprise_info b ON a.enterprise_id = b.id
		LEFT JOIN enterprise_info c ON b.parent_id = c.id
		WHERE
			1 = 1
		AND a.del_date IS NULL
       <if test="id!=null">
          and a.id = #{id}
       </if>
       <if test="name!=null and name!=''">
          and b.name LIKE CONCAT(CONCAT('%', #{name}), '%')
       </if>
       <if test="type!=null">
          and a.type = #{type}
       </if>
       <if test="contractState!=null">
          and a.contract_state = #{contractState}
       </if>
       <if test="checkState!=null">
          and a.check_state = #{checkState}
       </if>
       <if test="trainState!=null">
          and a.train_state = #{trainState}
       </if>
       <if test="trainCheckState!=null">
          and a.train_check_state = #{trainCheckState}
       </if>
       <if test="checkCount!=null">
          and a.check_count = #{checkCount}
       </if>
       <if test="cCode!=null and cCode!=''">
          and b.c_code LIKE CONCAT(CONCAT('%', #{cCode}), '%')
       </if>
       <if test="lastCheckState!=null and lastCheckState!=''">
          and a.last_check_state = #{lastCheckState}
       </if>
       <if test="isTrain!=null and isTrain!=''">
          and a.train_check_state > -1
       </if>
       <if test="isChcek!=null and isChcek!=''">
          and a.last_check_state > -1
       </if>
  </select>
  
  <select id="countByYear" parameterType="java.util.HashMap" resultType="java.util.HashMap">
       SELECT
			a. YEAR,
			sum(a. VALUE) AS
		VALUE
		
		FROM
			(
				SELECT
					count(*) AS
				VALUE
					,
					DATE_FORMAT(t.last_check_date, '%Y') AS YEAR
				FROM
					safety_production_consult t
				WHERE
					t.del_date IS NULL
				AND t.last_check_state IS NOT NULL
				AND (
					t.last_check_state = 1
					AND t.type = 1
				)
				GROUP BY
					DATE_FORMAT(t.last_check_date, '%Y')
				UNION ALL
					SELECT
						count(*) AS
					VALUE
						,
						DATE_FORMAT(t.check_date, '%Y') AS YEAR
					FROM
						safety_production_consult t
					WHERE
						t.del_date IS NULL
					AND t.check_date IS NOT NULL
					AND (t.check_state = 1 AND t.type = 2)
					GROUP BY
						DATE_FORMAT(t.check_date, '%Y')
			) a
		GROUP BY
			a. YEAR
  </select>
</mapper>